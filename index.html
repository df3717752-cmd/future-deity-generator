<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µé€ ä½ çš„å°ˆå±¬å®ˆè­·ç¥</title>
    <!-- å¼•å…¥ Tailwind CSS ç¢ºä¿éŸ¿æ‡‰å¼è¨­è¨ˆ --><script src="https://cdn.tailwindcss.com"></script>
    <script>
        // è¨­å®šè‡ªè¨‚ä¸»é¡Œé¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deity-bg': '#F0E6D2', // èƒŒæ™¯è‰² (æ·ºç±³é»ƒ/æ·ºè¤)
                        'deity-text': '#9B7E50', // æ–‡å­—è‰² (æ·±è¤/é‡‘)
                        'deity-accent': '#DDB466', // æ¡†ç·š/æŒ‰éˆ•ä¸»è‰² (é‡‘é»ƒ/é»ƒè¤)
                        'deity-dark': '#7A643F', // Hover/æ·±è‰²é™°å½±
                        'deity-light': '#F7F2E6', // Canvas æ¼¸è®Šäº®è‰²
                    }
                }
            }
        }
    </script>
    <style>
        /* ä½¿ç”¨ Noto Serif TC */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght400;700&display=swap');
        body {
            font-family: 'Noto Serif TC', serif; 
            background-color: #F0E6D2; /* èƒŒæ™¯é¡è‰²: #F0E6D2 */
        }
        /* ç¢ºä¿ Canvas èƒ½å¤ æ­£ç¢ºç¹ªåœ– */
        #deity-canvas {
            border: 2px solid #DDB466; /* æ¡†ç·šé¡è‰²: #DDB466 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* é¸æ“‡æŒ‰éˆ•é¢¨æ ¼ */
        .option-button {
            transition: all 0.2s;
        }
        .option-button.selected {
            border-width: 3px;
            border-color: #DDB466; /* é¸ä¸­æ¡†ç·š: #DDB466 */
            box-shadow: 0 0 10px rgba(155, 126, 80, 0.5); /* é™°å½±ä½¿ç”¨æ–‡å­—è‰² */
            transform: scale(1.05);
        }
        /* è¼‰å…¥ç•«é¢æ–‡å­—é¡è‰² */
        #loading-overlay div {
            color: #9B7E50;
        }
        /* è®“æ–‡å­—å€å¡Šèƒ½éš¨è‘— LLM è¼¸å‡ºè‡ªå‹•èª¿æ•´é«˜åº¦ */
        #wish-input {
            resize: vertical;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-deity-text mb-6">ğŸ”® å‰µé€ ä½ çš„å°ˆå±¬å®ˆè­·ç¥</h1>
        <p class="text-center text-gray-600 mb-8">è‡ªç”±æ­é…å…ƒç´ ã€é¸æ“‡å±¬æ€§ï¼Œå‰µé€ æ‚¨çš„å°ˆå±¬ã€Œå®ˆè­·ç¥ã€ä¸¦è¨±ä¸‹é¡˜æœ›ï¼</p>

        <div id="loading-overlay" class="fixed inset-0 bg-deity-bg/80 flex items-center justify-center z-50 hidden">
            <div class="text-xl font-semibold">è¼‰å…¥å…ƒç´ ä¸­ï¼Œè«‹ç¨å€™...</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- å·¦å´ï¼šå¡ç‰‡é è¦½å€ -->
            <div class="order-1 lg:order-2 bg-white p-6 rounded-xl shadow-lg flex flex-col items-center h-fit lg:sticky lg:top-8">
                <h2 class="text-2xl font-semibold mb-4 text-deity-text">æ‚¨çš„å®ˆè­·ç¥é è¦½</h2>
                <!-- Canvas ç¹ªåœ–å€åŸŸï¼Œè¨­å®šç‚º 4:3 æ¯”ä¾‹ --><canvas id="deity-canvas" width="300" height="400" class="w-full max-w-sm rounded-lg mb-4"></canvas>
                
                <div id="event-card" class="bg-deity-light border-l-4 border-deity-accent p-4 rounded-lg w-full max-w-sm hidden">
                    <p class="text-deity-dark font-bold mb-1">âœ¨ éš¨æ©Ÿç¥ç¦å¡</p>
                    <p id="event-text" class="text-deity-dark text-sm"></p>
                </div>

                <button id="download-btn" class="mt-6 w-full max-w-sm bg-deity-accent hover:bg-deity-dark text-white font-bold py-3 rounded-xl shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    ä¸‹è¼‰æ‚¨çš„å°ˆå±¬å®ˆè­·ç¥å¡ (PNG)
                </button>
                <p id="nickname-display" class="mt-2 text-sm text-deity-text font-semibold"></p>
            </div>

            <!-- å³å´ï¼šé¸æ“‡å€å¡Š --><div class="order-2 lg:order-1 space-y-8">
                <!-- æ­¥é©Ÿä¸€ï¼šæ‹¼è²¼è¨­è¨ˆ --><div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-deity-text">æ­¥é©Ÿä¸€ï¼šæ‹¼è²¼è¨­è¨ˆ</h2>
                    <div id="element-selection" class="space-y-4">
                        <!-- å…ƒç´ é¸æ“‡å€å¡Šå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ --></div>
                </div>

                <!-- æ­¥é©ŸäºŒï¼šè³¦äºˆåŠ›é‡ --><div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-deity-text">æ­¥é©ŸäºŒï¼šè³¦äºˆåŠ›é‡å±¬æ€§</h2>
                    <p class="text-sm text-gray-700 mb-3">ç¥‚çš„åŠ›é‡å±¬æ€§æ˜¯ï¼Ÿ</p>
                    <div id="attribute-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- å±¬æ€§æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ --></div>
                    
                    <h3 class="text-lg font-medium mt-6 mb-3 text-gray-700">æƒ³åŠ å…¥ä¸€é»éš¨æ©Ÿç¥ç¦å—ï¼Ÿ</h3>
                    <div id="blessing-toggle" class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="blessing" value="yes" checked class="form-radio text-deity-accent focus:ring-deity-accent">
                            <span class="text-gray-700">æƒ³ï¼ï¼ˆæˆ‘æƒ³æŠ½åˆ°ç¥ç§˜äº‹ä»¶å¡âœ¨ï¼‰</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="blessing" value="no" class="form-radio text-deity-accent focus:ring-deity-accent">
                            <span class="text-gray-700">ä¸ç”¨ï¼ˆæˆ‘åªæƒ³å°ˆå¿ƒè¨­è¨ˆï¼‰</span>
                        </label>
                    </div>
                </div>

                <!-- æ­¥é©Ÿä¸‰/å››ï¼šç¥ˆé¡˜èˆ‡é¡¯éˆ --><div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-deity-text">æ­¥é©Ÿä¸‰/å››ï¼šç¥ˆé¡˜èˆ‡é¡¯éˆ</h2>
                    
                    <h3 class="text-lg font-medium mb-3 text-gray-700">Q7. ä½ å¸Œæœ›ç¥å¡ä¸Šé¡¯ç¤ºçš„åå­—ï¼æš±ç¨±ï¼Ÿ</h3>
                    <input type="text" id="nickname-input" maxlength="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-deity-accent focus:border-deity-accent" placeholder="ä¾‹å¦‚ï¼šå¹¸é‹æ˜Ÿ (æœ€å¤š10å­—)">
                    
                    <h3 class="text-lg font-medium mt-6 mb-3 text-gray-700">ä½ å¸Œæœ›é€™ä½æœªä¾†ç¥ä¿ä½‘ä½ å¯¦ç¾ä»€éº¼é¡˜æœ›ï¼Ÿ</h3>
                    <div class="flex flex-col space-y-2">
                         <textarea id="wish-input" rows="3" maxlength="100" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-deity-accent focus:border-deity-accent" placeholder="ä½ å¸Œæœ›é€™ä½ä»™äººä¿ä½‘ä½ å¯¦ç¾ä»€éº¼é¡˜æœ›ï¼Ÿ (æœ€å¤š100å­—)"></textarea>
                         <div class="flex justify-between items-center">
                            <button id="refine-wish-btn" class="flex items-center px-4 py-2 bg-deity-text text-white text-sm rounded-lg hover:bg-deity-dark transition disabled:opacity-50">
                                <span id="refine-wish-text">âœ¨ è¨±é¡˜è©æ˜‡è¯ (Gemini)</span>
                            </button>
                            <p class="text-right text-sm text-gray-500 mt-1"><span id="char-count">0</span> / 100 å­—</p>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-medium mt-6 mb-3 text-gray-700">Q8. æ˜¯å¦é¡˜æ„å°‡ä½ çš„å¡ç‰‡æ”¾ä¸Šã€å®ˆè­·ç¥ç‰†ã€å±•ç¤ºï¼Ÿ</h3>
                    <div id="consent-toggle" class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="consent" value="yes" checked class="form-radio text-deity-accent focus:ring-deity-accent">
                            <span class="text-gray-700">âœ… é¡˜æ„</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="consent" value="no" class="form-radio text-deity-accent focus:ring-deity-accent">
                            <span class="text-gray-700">âŒ ä¸é¡˜æ„</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const CANVAS_WIDTH = 600;
        const CANVAS_HEIGHT = 800;
        const FONT_FAMILY = 'Noto Serif TC'; 
        const PADDING = 50;

        const canvas = document.getElementById('deity-canvas');
        const ctx = canvas.getContext('2d');

        // è¨­å®š Canvas çš„å¯¦éš›ç¹ªåœ–å°ºå¯¸ (ç”¨æ–¼é«˜è§£æåº¦è¼¸å‡º)
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;

        // è¨­å®š Canvas åœ¨é é¢ä¸Šçš„é¡¯ç¤ºå°ºå¯¸ (ç”¨æ–¼ç¾è§€é è¦½)
        canvas.style.width = '100%';
        canvas.style.height = (CANVAS_HEIGHT / CANVAS_WIDTH) * canvas.offsetWidth + 'px';

        // --- æ­¥é©Ÿä¸€ï¼šæ‹¼è²¼è¨­è¨ˆå…ƒç´  (å·²æ›¿æ›ç‚º GitHub Raw é€£çµ) ---
        // å‡è¨­æ‚¨çš„ GitHub å€‰åº«è·¯å¾‘ç‚º https://raw.githubusercontent.com/df3717752-cmd/future-deity-generator/main/future-deity-project/
        const BASE_URL = 'https://raw.githubusercontent.com/df3717752-cmd/future-deity-generator/main/future-deity-project/';

        const elementData = {
            gender: [
                { id: 'goddess', name: 'å¥³ç¥', imageUrl: `${BASE_URL}gender/gender_%E5%A5%B3%E7%A5%9E.png` },
                { id: 'god', name: 'ç”·ç¥', imageUrl: `${BASE_URL}gender/gender_%E7%94%B7%E7%A5%9E.png` },
            ],
            headwear: [
                { id: 'beret', name: 'è²é›·å¸½', imageUrl: `${BASE_URL}headwear/headwear_%E8%B2%9D%E9%9B%B7%E5%B8%BD.png` },
                { id: 'party', name: 'æ´¾å°å¸½', imageUrl: `${BASE_URL}headwear/headwear_%E6%B4%BE%E5%B0%8D%E5%B8%BD.png` },
                { id: 'straw', name: 'è‰å¸½', imageUrl: `${BASE_URL}headwear/headwear_%E8%8D%89%E5%B8%BD.png` },
                { id: 'baseball', name: 'æ£’çƒå¸½', imageUrl: `${BASE_URL}headwear/headwear_%E6%A3%92%E7%90%83%E5%B8%BD.png` },
                { id: 'reggae', name: 'é›·é¬¼é ­', imageUrl: `${BASE_URL}headwear/headwear_%E9%9B%B7%E9%AC%BC%E9%A0%AD.png` },
                { id: 'reindeer', name: 'é¦´é¹¿å¸½', imageUrl: `${BASE_URL}headwear/headwear_%E9%A6%B4%E9%B9%BF%E5%B8%BD.png` },
                { id: 'fisherman', name: 'æ¼å¤«å¸½', imageUrl: `${BASE_URL}headwear/headwear_%E6%BC%81%E5%A4%AB%E5%B8%BD.png` },
                { id: 'phoenix', name: 'é³³å† ', imageUrl: `${BASE_URL}headwear/headwear_%E9%B3%B3%E5%86%A0.png` },
                { id: 'tophat', name: 'ç¦®å¸½', imageUrl: `${BASE_URL}headwear/headwear_%E7%A6%AE%E5%B8%BD.png` },
                { id: 'twin_tails', name: 'é›™é¦¬å°¾', imageUrl: `${BASE_URL}headwear/headwear_%E9%9B%99%E9%A6%AC%E5%B0%BE.png` },
            ],
            outfit: [
                { id: 'hoodie', name: 'å¸½T', imageUrl: `${BASE_URL}outfit/outfit_%E5%B8%BDT.png` },
                { id: 'suit', name: 'è¥¿è£', imageUrl: `${BASE_URL}outfit/outfit_%E8%A5%BF%E8%A3%9D.png` },
                { id: 'sweater', name: 'æ¯›è¡£', imageUrl: `${BASE_URL}outfit/outfit_%E6%AF%9B%E8%A1%A3.png` },
                { id: 'techwear', name: 'ç§‘æŠ€æœ', imageUrl: `${BASE_URL}outfit/outfit_%E7%A7%91%E6%8A%80%E6%9C%8D.png` },
                { id: 'deity_robe', name: 'ç¥è¡£', imageUrl: `${BASE_URL}outfit/outfit_%E7%A5%9E%E8%A1%A3.png` },
                { id: 'dress', name: 'æ´‹è£', imageUrl: `${BASE_URL}outfit/outfit_%E6%B4%8B%E8%A3%9D.png` },
                { id: 'basketball', name: 'ç±ƒçƒèƒŒå¿ƒ', imageUrl: `${BASE_URL}outfit/outfit_%E7%B1%83%E7%90%83%E8%83%8C%E5%BF%83.png` },
                { id: 'denim', name: 'ç‰›ä»”', imageUrl: `${BASE_URL}outfit/outfit_%E7%89%9B%E4%BB%94.png` },
                { id: 'leather', name: 'çš®è¡£', imageUrl: `${BASE_URL}outfit/outfit_%E7%9A%AE%E8%A1%A3.png` },
                { id: 'police', name: 'è­¦æœ', imageUrl: `${BASE_URL}outfit/outfit_%E8%AD%A6%E6%9C%8D.png` },
                { id: 'chef', name: 'å»šå¸«æœ', imageUrl: `${BASE_URL}outfit/outfit_%E5%BB%9A%E5%B8%AB%E6%9C%8D.png` },
            ],
            background: [
                { id: 'gold', name: 'é‡‘å…‰', imageUrl: `${BASE_URL}bg/bg_%E9%87%91%E5%85%89.png` },
                { id: 'art', name: 'è—è¡“', imageUrl: `${BASE_URL}bg/bg_%E8%97%9D%E8%A1%93.png` },
                { id: 'dawn', name: 'æ›™å…‰', imageUrl: `${BASE_URL}bg/bg_%E6%9B%99%E5%85%89.png` },
                { id: 'dream', name: 'å¤¢å¹»', imageUrl: `${BASE_URL}bg/bg_%E5%A4%A2%E5%B9%BB.png` },
                { id: 'night', name: 'é»‘å¤œ', imageUrl: `${BASE_URL}bg/bg_%20%E9%BB%91%E5%A4%9C.png` },
                { id: 'cloud', name: 'ç™½é›²', imageUrl: `${BASE_URL}bg/bg_%E7%99%BD%E9%9B%B2.png` },
                { id: 'tech', name: 'ç§‘æŠ€', imageUrl: `${BASE_URL}bg/bg_%E7%A7%91%E6%8A%80.png` },
            ]
        };

        // --- æ­¥é©ŸäºŒï¼šè§’è‰²å±¬æ€§ (å·²æ›´æ–°) ---
        const attributes = [
            'é‹å‹•ç¥', 'æ—…éŠç¥', 'éŠæˆ²ç¥', 'æ¸…æ½”ç¥', 'é£Ÿç¥', 'è—è¡“ç¥', 'é†«è—¥ç¥', 
            'å¤§åœ°ç¥', 'è€ƒè©¦ç¥', 'æ´¾å°ç¥', 'ç¾å¦ç¥', 'ç§‘æŠ€ç¥', 'ç¡ç¥',
        ];

        // --- éš¨æ©Ÿç¥ç¦ (å·²æ›´æ–°) ---
        const blessingMessages = [
            'ç¥‚æ‚„æ‚„æ´¾äº†ä¸€ä½è¿·ä½ å®ˆè­·éˆé™ªåœ¨ä½ èº«é‚Šï¼Œç¢ºä¿ä»Šå¤©ä¸€åˆ‡é †åˆ©ã€‚',
            'ç¥‚ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½ï¼Œæ±ºå®šçµ¦ä½ é¡å¤–çš„å¹¸é‹å€¼ï¼‹3ã€‚',
            'ç¥‚å‰›æ›¿ä½ åœ¨å®‡å®™æ’éšŠè¡¨ä¸ŠåŠƒä¸‹ã€Œå„ªå…ˆã€æ¨™è¨˜ã€‚',
            'é€™ä½ç¥æ˜ä»Šæ™šæœƒå®ˆåœ¨ä½ çš„å¤¢è£¡ï¼Œæ›¿ä½ æ“¦å»æ‰€æœ‰ç…©æƒ±ã€‚',
            'æœªä¾†èƒ½é‡æ­£åœ¨é è¿‘ï¼Œä½ æœƒçªç„¶è¦ºå¾—å¿ƒå¾ˆå®‰å®šã€‚',
            'ç¥‚å¹«ä½ é‡æ–°æ•´ç†äº†æƒ…ç·’æ«ƒå­ï¼ŒæŠŠç´¯çš„æ±è¥¿éƒ½æ”¾åœ¨æœ€åº•å±¤ã€‚',
            'ç¥‚å‰›ç‚ºä½ è£œæ»¿èƒ½é‡æ§½ï¼Œæ¥ä¸‹ä¾†çš„äº‹ä½ éƒ½èƒ½è™•ç†å¾—å¾ˆã€‚',
            'ç¥‚å¹«ä½ æƒæ‰è‚©ä¸Šçš„å£“åŠ›ç°å¡µï¼Œä½ æœƒæ›´è¼•é¬†ã€‚',
            'ç¥‚ç¥ä½ ã€Œé †å¿ƒï¼‹3ã€å¥½é‹ï¼‹2ã€ç¡é£½ï¼‹5ã€ã€‚',
            'ä½ ä»Šå¤©çš„å®ˆè­·æ©Ÿç‡æå‡äº† 87%ï¼Œå› ç‚ºç¥‚å¿ƒæƒ…å¾ˆå¥½ã€‚',
            'ç¥‚æ›¿ä½ åœ¨å‘½é‹å‰æ–¹é»äº†ä¸€ç›æš–å…‰ã€‚',
            'ä½ çš„å®ˆè­·ç¥æ­£åœ¨èª¿é…ä¸€ç¨®æ–°é­”æ³•ï¼Œé è¨ˆä¸‰å¤©å¾Œç”Ÿæ•ˆã€‚',
            'ç¥‚æ‰“é–‹ä¸€æ‰‡å°çª—ï¼ŒæŠŠå¥½äº‹æ¨å‘ä½ é€™é‚Šã€‚',
            'ä»Šæ—¥æ˜Ÿéš›é¢¨å‘è‰¯å¥½ï¼Œç¥æ˜æ‰¹å‡†ä½ å¸¶èµ°é¡å¤–çš„å¹¸é‹ç²’å­ã€‚',
            'ç¥‚åœ¨ä½ çš„éˆé­‚å¤–å¥—ä¸Šç¸«ä¸Šäº†ã€Œä¸æ€•æŒ«æŠ˜ã€çš„çµç•Œç¬¦ã€‚',
            'ç¥‚æ–½æ”¾ã€Œè·¯ä¸Šä¸æœƒçµ†å€’ã€é­”æ³•ï¼Œåªé™ä»Šå¤©ä½¿ç”¨ã€‚',
            'å®‡å®™å‚³ä¾†è¨Šæ¯ï¼šä½ çš„åå­—å‰›è¢«åˆ—å…¥ã€Œå€¼å¾—è¢«æ„›åå–®ã€ã€‚',
            'ç¥‚å¹«ä½ å•äº†ä¸€ä¸‹æœªä¾†ï¼Œæœªä¾†èªªï¼šã€Œæ”¾å¿ƒï¼Œæˆ‘åœ¨æº–å‚™äº†ã€‚ã€',
            'ç¥‚è—äº†ä¸€é¡†å°å°çš„æ¦®è€€ç¨®å­åœ¨ä½ å£è¢‹ï¼Œé©æ™‚æœƒç™¼èŠ½ã€‚',
            'ç¥‚æ­£åœ¨ä½ çš„æ™‚é–“ç·šå·å·åŠ ç³–ï¼Œç”œçš„å¿«åˆ°äº†ã€‚',
            'ç¥‚è¦ºå¾—ä½ å¤ªç´¯ï¼Œæ±ºå®šè®“ä½ ä»Šå¤©é‡åˆ°ä¸€ä»¶å°ç¢ºå¹¸ã€‚',
            'ä½ çš„å®ˆè­·ç¥å»ºè­°ä½ ä»Šæ™šå–ä¸€æ¯æº«æš–çš„é£²å“ï¼Œå®ƒæœƒç”Ÿæ•ˆã€‚',
            'ä»Šå¤©ä½ æœƒè½åˆ°ä¸€å¥æ„å¤–æº«æŸ”çš„è©±ï¼Œé‚£æ˜¯ç¥‚å®‰æ’çš„ã€‚',
            'ç¥‚æ›¿ä½ æ‰äº†ä¸€ä¸‹å‘½é‹çš„è‚©è†€ï¼Œå£“åŠ›æœƒæ¸›è¼•ã€‚',
            'ç¥‚èªªä½ å€¼å¾—ä¸€æ®µå®‰éœï¼Œæ‰€ä»¥ç¥‚ä»Šå¤©å¹«ä½ æŠŠåµé›œéœéŸ³äº†ã€‚',
            'ä»Šå¤©ä½ æœƒçªç„¶è¦ºå¾—ã€Œå¥½åƒæ²’é‚£éº¼ç³Ÿã€â€”â€”é‚£æ˜¯ç¥‚ã€‚',
            'ç¥‚å¹«ä½ æš«åœäº†å¿ƒè£¡çš„é¢¨é›¨ 3 å°æ™‚ï¼Œå¥½å¥½å‘¼å¸ã€‚',
            'æœ‰ä¸€é»é»å¹¸ç¦æ­£åœ¨é è¿‘ï¼Œé€Ÿåº¦æ¯”ä½ æƒ³åƒå¿«ã€‚',
            'ç¥‚æ›¿ä½ æŠŠå›°é›£é‡æ–°æ’åˆ—ï¼Œç¾åœ¨æœ€ç°¡å–®çš„è¢«æ”¾åœ¨å‰é¢äº†ã€‚',
            'ç¥‚å‰›å•Ÿå‹•ä½ çš„ã€Œæœªä¾†ç‰ˆæœ¬æ›´æ–°ã€ï¼Œæƒ…ç·’ç©©å®šåº¦ï¼‹20ã€‚',
            'ç¥‚æ´¾å‡ºå¥ˆç±³å°éšŠæ›¿ä½ æ¸…ç†è…¦è¢‹è£¡çš„é›œè¨Šã€‚',
            'ä¸€å€‹æ–°çš„å¯èƒ½æ€§æ­£åœ¨ä½ çš„äººç”Ÿå¾Œå°å®‰è£ã€‚',
            'ç¥‚æ›¿ä½ æ‰“é–‹ã€Œé«˜æ©Ÿç‡æˆåŠŸã€çš„é¸é …ã€‚',
            'ä½ çš„å®ˆè­·ç¥æŠŠä½ çš„äººç”Ÿé˜²ç«ç‰†åŠ åšäº†ã€‚',
            'ç¥‚åµæ¸¬åˆ°ä½ éœ€è¦é¼“å‹µï¼Œå·²å‚³é€èƒ½é‡åŒ…åˆ°ä½ å¿ƒåº•ã€‚',
            'å®‡å®™é›²ç«¯ç³»çµ±æ›¿ä½ å‚™ä»½äº†æ‰€æœ‰åŠªåŠ›ï¼Œä¸æœƒç™½è²»ã€‚',
            'ç¥‚ç‚ºä½ å„ªåŒ–äº†ã€Œå‹‡æ•¢ã€ç¨‹å¼ç¢¼ï¼Œå·²æˆåŠŸé‹è¡Œã€‚',
            'ç¥‚æ­£åœ¨è¨ˆç®—ä¸€æ¢å±¬æ–¼ä½ çš„æ·å¾‘ï¼Œè«‹ç¨å€™ã€‚',
            'ç¥‚æ›´æ–°äº†ä½ çš„å¥½é‹æ¼”ç®—æ³•ï¼Œç¾åœ¨æ•ˆç‡æ›´é«˜ã€‚',
            'ç¥‚ä»Šå¤©æœƒè³œä½ ä¸€ç¢—è®“äººå¿ƒæƒ…è®Šå¥½çš„ç†±æ¹¯ã€‚',
            'é£Ÿç¥å·²æ›¿ä½ åŠ é‡ã€Œå‹‡æ°£é…æ–™ã€ä¸€åŒ™ã€‚',
            'ç¥‚æ­£åœ¨ç…®ä¸€é‹æœƒè®“ä½ å¹¸ç¦çš„å’–å“©ï¼Œé¦™å‘³å¿«åˆ°äº†ã€‚',
            'ç¥‚æ›¿ä½ åšäº†ä¸€ä»½ã€Œä¸æ²®å–ªä¾¿ç•¶ã€ï¼Œè®“ä½ å…ƒæ°£ï¼‹50ã€‚',
            'ä»Šå¤©ä½ æœƒè«ååƒåˆ°å¥½åƒçš„æ±è¥¿ï¼Œé‚£æ˜¯ç¥‚å®‰æ’çš„ã€‚',
            'ç¥‚è®“ç”œé»ç²¾éˆæå‰é€é”ç”œç”œçš„äº‹ä»¶çµ¦ä½ ã€‚',
            'ä½ çš„ç¥æ˜è¦ºå¾—ä½ å€¼å¾—ä¸€æ¯é£²æ–™ï¼Œè«‹è‡ªå·±æŒ‘ã€‚',
            'ç¥‚å¹«ä½ æŠŠå£å¿ƒæƒ…ä¸Ÿé€²å®‡å®™çš„åƒåœ¾æ¡¶äº†ã€‚',
            'ä»Šå¤©ä½ ä¸æœƒè¸©åˆ°é›·ï¼Œå› ç‚ºç¥‚å…ˆè¸©éäº†ã€‚',
            'ç¥‚èªªä½ ä»Šå¤©å¾ˆå¯æ„›ï¼Œä¸æ¥å—åé§ã€‚',
            'ç¥‚è¦ºå¾—ä½ æ¯”è‡ªå·±æƒ³åƒçš„æ›´å‹‡æ•¢ï¼Œæ­£æ›¿ä½ å¢åŠ è€å¿ƒå€¼ã€‚',
            'ç¥‚æŠŠä½ æ˜¨å¤©çš„é›£éæ‹¿å»æ›äº†ä»Šå¤©çš„åŠ›é‡ã€‚',
            'æŸå€‹ä½ æœŸå¾…çš„ç­”æ¡ˆæ­£åœ¨é€æ¼¸è®Šå¾—æ¸…æ™°ã€‚',
            'ç¥‚ç‚ºä½ é»äº®äº†ä¸€å°æ®µè·¯ï¼Œè¶³å¤ ä½ å†å¾€å‰èµ°ä¸€æ­¥ã€‚',
            'ä»Šå¾Œæœƒè¶Šä¾†è¶Šé †åˆ©ï¼Œç¥‚æ­£åœ¨å®‰æ’ç†ç”±ã€‚',
            'ç¥‚åœ¨ä½ çš„å¿ƒä¸Šè²¼äº†ä¸€å¼µä¾¿åˆ©è²¼ï¼šåŠ æ²¹ï¼Œä½ å€¼å¾—æ›´å¥½ã€‚',
            'ä½ æ­£åœ¨æ‚„æ‚„è®Šå¾—æ›´å¼·ï¼Œç¥‚çœ‹è¦‹äº†ã€‚',
            'æŸå€‹é¡˜æœ›å·²è¢«ä¸Šå‚³åˆ°å®‡å®™ï¼Œæ­£åœ¨æ’ç¨‹ä¸­ã€‚',
            'ç¥‚èªªï¼šã€Œåˆ¥æ“”å¿ƒï¼Œæˆ‘éƒ½åœ¨ã€‚ã€',
            'ç¥‚ä»Šå¤©è®“ä½ åœ¨å··å¼„é‡ä¸Šä¸€ä»½å‰›å¥½éœ€è¦çš„æº«æŸ”ã€‚',
            'åœ¨å°å—çš„é¢¨è£¡ï¼Œä½ æœƒæ”¶åˆ°ä¸€å€‹æ„æƒ³ä¸åˆ°çš„å°ç¥ç¦ã€‚',
            'å¦‚æœä½ ä»Šå¤©å–åˆ°ç‰¹åˆ¥å¥½å–çš„é£²æ–™ï¼Œé‚£æ˜¯ç¥‚çš„å‚‘ä½œã€‚',
            'ç¥‚æŠŠä½ çš„ç…©æƒ±æŠ˜æˆç´™èˆ¹ï¼Œæ”¾é€²æ²³è£¡æ…¢æ…¢æ¼‚èµ°äº†ã€‚',
            'ç¥‚æ´¾äº†ä¸€é¡†æµæ˜Ÿå»¶å¾Œ 5 åˆ†é˜è½ä¸‹ï¼Œå‰›å¥½è®“ä½ çœ‹åˆ°ã€‚',
            'ç¥‚è®“ä½ çš„å¿ƒä»Šå¤©ç©¿ä¸Šä¸€ä»¶ã€ŒæŠ—ç…©èºã€æ¯›è¡£ã€‚',
            'ç¥‚èªªï¼šã€Œä½ å€¼å¾—è¢«å®‡å®™å¥½å¥½å°å¾…ã€‚ã€',
            'ç¥‚ç‚ºä½ æº–å‚™äº†æœ€ä½³çš„å‡ºå ´å®‰æ’ï¼Œè€å¿ƒç­‰å¾…ã€‚'
        ];


        // åˆå§‹ç‹€æ…‹
        const state = {
            gender: elementData.gender[0].id,
            headwear: elementData.headwear[0].id,
            outfit: elementData.outfit[0].id,
            background: elementData.background[0].id,
            attribute: attributes[0],
            wish: '',
            nickname: '', // Q7
            consent: 'yes', // Q8
            blessingToggle: 'yes', // Q6
            images: {}, 
            allElementsLoaded: false,
        };

        // --- Firebase ç›¸é—œé…ç½® (ç”¨æ–¼æœªä¾†å¯¦ç¾ç¤¾ç¾¤ç‰†) ---
        // (ä¿æŒä¸è®Š)


        // --- Gemini API æ•´åˆ ---
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = "AIzaSyBetxpyWKJKNsFABI0hRFA7QAPimixcuSI"; // å¯†é‘°å·²å¡«å…¥ï¼
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
        const REFINE_WISH_BTN = document.getElementById('refine-wish-btn');
        const REFINE_WISH_TEXT = document.getElementById('refine-wish-text');
        const WISH_INPUT = document.getElementById('wish-input');


        /**
         * åŸ·è¡Œå¸¶æœ‰æŒ‡æ•¸é€€é¿çš„ fetch è«‹æ±‚
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Too Many Requests, retry
                        await new Promise(resolve => setTimeout(resolve, delay * (2 ** i) + Math.random() * 1000));
                        continue;
                    } else {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                } catch (error) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * (2 ** i) + Math.random() * 1000));
                        continue;
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * å‘¼å« Gemini API é€²è¡Œæ–‡æœ¬ç”Ÿæˆ
         */
        async function callGeminiApi(userQuery, systemPrompt) {
            if (!API_KEY) {
                // æ‡‰æ€¥è™•ç†ï¼Œå› ç‚ºå¯†é‘°å·²ç¶“å¡«å…¥ï¼Œä½†ä¿ç•™æ­¤é˜²å‘†
                console.error("éŒ¯èª¤ï¼šè«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Gemini API å¯†é‘°ï¼");
                return "API é€£ç·šå¤±æ•—ï¼šå¯†é‘°ç‚ºç©ºã€‚";
            }
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    // å°‡è¼¸å‡ºå­—æ•¸é™åˆ¶åœ¨ 80 å­—ä»¥å…§ï¼Œç¬¦åˆå¡ç‰‡ç‰ˆé¢éœ€æ±‚
                    maxOutputTokens: 80 
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(API_URL, options);
                const result = await response.json();
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!generatedText) {
                     // å¦‚æœ API è¿”å›ç„¡å…§å®¹ï¼Œæ‹‹å‡ºéŒ¯èª¤
                    console.error("Gemini API returned no text:", result);
                    return "ç¥è«­èƒ½é‡ä¸è¶³ï¼Œè«‹é‡æ–°å˜—è©¦ï¼";
                }

                // æ¸…ç†è¼¸å‡ºæ–‡æœ¬ï¼Œç§»é™¤ä¸å¿…è¦çš„å¼•è™Ÿæˆ–æ›è¡Œ
                return generatedText.trim().replace(/^['"\s]+|['"\s]+$/g, '');

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "å®‡å®™é€£ç·šä¸­æ–·ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }

        /**
         * âœ¨ è¨±é¡˜è©æ˜‡è¯ï¼šä½¿ç”¨ Gemini API å¼·åŒ–ç”¨æˆ¶çš„é¡˜æœ›ã€‚
         */
        async function refineWish() {
            const currentWish = state.wish.trim();
            const selectedAttribute = state.attribute;

            if (currentWish.length < 5) {
                // å¦‚æœé¡˜æœ›å¤ªçŸ­ï¼Œçµ¦äºˆæç¤º
                WISH_INPUT.placeholder = "è«‹è¼¸å…¥è‡³å°‘ 5 å€‹å­—å†é€²è¡Œæ˜‡è¯ï¼";
                WISH_INPUT.focus();
                return;
            }

            // è¨­ç½®æŒ‰éˆ•ç‚ºè¼‰å…¥ç‹€æ…‹
            REFINE_WISH_BTN.disabled = true;
            REFINE_WISH_TEXT.textContent = 'ç¥è«­ç”Ÿæˆä¸­...';

            const systemPrompt = `ä½ æ˜¯ä¸€ä½æŒç®¡æœªä¾†ã€ç¥è–ä¸”å……æ»¿è©©æ„çš„ç¥è«­å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä¿¡å¾’ç°¡çŸ­çš„é¡˜æœ›ï¼Œå°‡å…¶æ”¹å¯«æˆä¸€æ®µå……æ»¿åŠ›é‡æ„Ÿã€å„ªé›…æˆ–å²è©©é¢¨æ ¼çš„ã€Œç¥ˆç¦±æ–‡ã€ã€‚é€™æ®µç¥ˆç¦±æ–‡å¿…é ˆç°¡æ½”ï¼Œé•·åº¦ä¸è¶…é 30 å€‹ä¸­æ–‡å­—ï¼Œä¸”å¿…é ˆèˆ‡ä¿¡å¾’é¸æ“‡çš„ã€Œå®ˆè­·ç¥ã€å±¬æ€§ï¼ˆä¾‹å¦‚ï¼š${selectedAttribute}ï¼‰ç›¸å‘¼æ‡‰ã€‚åªè¼¸å‡ºæ˜‡è¯å¾Œçš„ç¥ˆç¦±æ–‡ï¼Œä¸éœ€è¦ä»»ä½•é¡å¤–çš„æ¨™é»ç¬¦è™Ÿæˆ–ç¨±è¬‚ã€‚`;

            const userQuery = `é€™æ˜¯ä¿¡å¾’çš„é¡˜æœ›ï¼Œè«‹æ˜‡è¯ï¼š"${currentWish}"`;

            const refinedWish = await callGeminiApi(userQuery, systemPrompt);

            // æ›´æ–° UI ç‹€æ…‹
            REFINE_WISH_BTN.disabled = false;
            REFINE_WISH_TEXT.textContent = 'âœ¨ è¨±é¡˜è©æ˜‡è¯ (Gemini)';
            
            // å¦‚æœé€£ç·šå¤±æ•—ï¼Œæœƒé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œä¸å½±éŸ¿åŸé¡˜æœ›
            if (refinedWish.includes("API é€£ç·šå¤±æ•—") || refinedWish.includes("å®‡å®™é€£ç·šä¸­æ–·")) {
                // é€™è£¡æˆ‘å€‘ä¸ä½¿ç”¨ alertï¼Œè€Œæ˜¯å°‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸Š
                 REFINE_WISH_TEXT.textContent = refinedWish.substring(0, 10); // é¡¯ç¤ºéŒ¯èª¤æç¤º
                 setTimeout(() => {
                    REFINE_WISH_TEXT.textContent = 'âœ¨ è¨±é¡˜è©æ˜‡è¯ (Gemini)';
                 }, 3000);
                 return;
            }

            // å°‡æ˜‡è¯å¾Œçš„é¡˜æœ›æ›´æ–°åˆ°è¼¸å…¥æ¡†å’Œç‹€æ…‹
            state.wish = refinedWish.substring(0, 100); // ç¢ºä¿ä¸è¶…éæœ€å¤§é•·åº¦
            WISH_INPUT.value = state.wish;
            WISH_INPUT.dispatchEvent(new Event('input')); // è§¸ç™¼ç¹ªåœ–å’Œå­—æ•¸è¨ˆç®—

            // è¦–è¦ºå›é¥‹
            WISH_INPUT.classList.add('border-deity-accent', 'border-4');
            setTimeout(() => {
                WISH_INPUT.classList.remove('border-deity-accent', 'border-4');
            }, 1000);
        }

        // --- æ ¸å¿ƒç¹ªåœ–å‡½æ•¸ ---

        /**
         * å°‡æ–‡å­—è‡ªå‹•æ›è¡Œä¸¦ç¹ªè£½åœ¨ Canvas ä¸Šã€‚
         * @param {boolean} stroke æ˜¯å¦ç¹ªè£½æé‚Š
         */
        function drawWrappedText(text, x, y, maxWidth, lineHeight, stroke) {
            const words = text.split('');
            let line = '';
            let lineY = y;

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n];
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && n > 0) {
                    if (stroke) ctx.strokeText(line, x, lineY); // ç¹ªè£½æé‚Š
                    ctx.fillText(line, x, lineY);
                    line = words[n];
                    lineY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            if (stroke) ctx.strokeText(line, x, lineY); // ç¹ªè£½æœ€å¾Œä¸€è¡Œçš„æé‚Š
            ctx.fillText(line, x, lineY);
        }

        /**
         * ç¹ªè£½å¸¶åœ“è§’çš„çŸ©å½¢ã€‚
         */
        function drawRoundedRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.arcTo(x + width, y, x + width, y + radius, radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
            ctx.lineTo(x + radius, y + height);
            ctx.arcTo(x, y + height, x, y + height - radius, radius);
            ctx.lineTo(x, y + radius);
            ctx.arcTo(x, y, x + radius, y, radius);
            ctx.closePath();
        }

        /**
         * ç¹ªè£½å®Œæ•´çš„å®ˆè­·ç¥å¡ç‰‡ã€‚
         */
        function drawDeityCard() {
            if (!state.allElementsLoaded) return;
            
            // 1. æ¸…é™¤ Canvas ä¸¦ç¹ªè£½èƒŒæ™¯
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            // æ ¹æ“šé¸æ“‡çš„èƒŒæ™¯ï¼Œç¹ªè£½èƒŒæ™¯åœ–å±¤ 
            const bgImg = state.images[state.background];
            if (bgImg) {
                // ç¢ºä¿èƒŒæ™¯åœ–å¡«æ»¿æ•´å€‹ Canvas
                ctx.drawImage(bgImg, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            } else {
                // é è¨­æ¼¸è®ŠèƒŒæ™¯ (å¦‚æœèƒŒæ™¯åœ–æ²’è¼‰å…¥)
                const gradient = ctx.createLinearGradient(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                gradient.addColorStop(0, '#F7F2E6'); 
                gradient.addColorStop(1, '#E6DDBB'); 
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }

            // 2. ç¹ªè£½å¡ç‰‡é‚Šæ¡†/è£é£¾
            ctx.strokeStyle = '#DDB466'; // æ¡†ç·šé¡è‰²: #DDB466
            ctx.lineWidth = 10;
            ctx.strokeRect(PADDING / 2, PADDING / 2, CANVAS_WIDTH - PADDING, CANVAS_HEIGHT - PADDING);

            // --- 3. ç¹ªè£½å…ƒç´ åœ–åƒ (å±¤æ¬¡: æ€§åˆ¥ -> æœè£ -> é ­é£¾) ---
            
            // è§’è‰²ç¹ªåœ–åŸºæº–å°ºå¯¸ (å½±éŸ¿ headwear å’Œ outfit çš„åŸºæº–)
            // èª¿æ•´ç‚º CANVAS_WIDTH çš„ 37.5% (åŸå§‹ 75% çš„ 50%)
            const BASE_SIZE = CANVAS_WIDTH * 0.375; // 225
            
            // è§’è‰²åŸºåº•å‚ç›´ä¸­å¿ƒé» (Y è»¸ä½ç½®)
            // åŸå§‹ Y_CENTER æ˜¯ 320ï¼Œå‘ä¸Šç§»å‹• 3 å…¬åˆ† (ç´„ 90 åƒç´ )
            const Y_CENTER = 320 - 90; // èª¿æ•´ç‚º 230
            
            // å‚ç›´åç§»è·é›¢ (headwear å¾€ä¸Šï¼Œoutfit å¾€ä¸‹)
            const VERTICAL_OFFSET = 100; 
            
            const GENDER_SCALE_FACTOR = 1.10; // gender æ”¾å¤§åˆ° 110%
            const HEADWEAR_SCALE_FACTOR = 1.15; // headwear æ”¾å¤§åˆ° 115%
            const OUTFIT_SCALE_FACTOR = 3.00; // outfit ä¿æŒ 300% æ”¾å¤§
            
            // ã€æ–°è®Šæ•¸ã€‘ outfit å‘ä¸‹é¡å¤–ç§»å‹•ç¸½é‡
            const OUTFIT_MOVE_DOWN_PX = 328.5; 
            // ã€æ–°è®Šæ•¸ã€‘ headwear å‘ä¸‹ç§»å‹• 1 å…¬åˆ† (ç´„ 30 åƒç´ )
            const HEADWEAR_MOVE_DOWN_PX = 30; 
            
            // æ ¹æ“šå±¤æ¬¡é †åºå®šç¾©æ‰€æœ‰è¦ç¹ªè£½çš„å…ƒç´ åŠå…¶åƒæ•¸
            const elementsToDraw = [
                // 1. æ€§åˆ¥ (æœ€åº•å±¤ï¼Œå¥—ç”¨ç¸®æ”¾æ¯”ä¾‹)
                { 
                    type: 'gender', 
                    img: state.images[state.gender], 
                    size: BASE_SIZE * GENDER_SCALE_FACTOR, // æ‡‰ç”¨ 110% æ”¾å¤§
                    y: Y_CENTER 
                },
                // 2. æœè£ (ä¸­é–“å±¤ï¼Œæ‡‰ç”¨ 300% æ”¾å¤§ï¼Œå¾€ä¸‹åç§» 1/4 + é¡å¤–ç§»å‹•)
                { 
                    type: 'outfit', 
                    img: state.images[state.outfit], 
                    size: BASE_SIZE * OUTFIT_SCALE_FACTOR, // æ‡‰ç”¨ 300% æ”¾å¤§
                    y: Y_CENTER + VERTICAL_OFFSET + OUTFIT_MOVE_DOWN_PX // é¡å¤–å¢åŠ åç§»
                },
                // 3. é ­é£¾ (æœ€ä¸Šå±¤ï¼Œç¸®æ”¾ 115%ï¼Œå¾€ä¸Šåç§» 1/4)
                { 
                    type: 'headwear', 
                    img: state.images[state.headwear], 
                    size: BASE_SIZE * HEADWEAR_SCALE_FACTOR, // æ‡‰ç”¨ 115% æ”¾å¤§
                    y: Y_CENTER - VERTICAL_OFFSET + HEADWEAR_MOVE_DOWN_PX // å¢åŠ  30px å‘ä¸‹ç§»å‹•
                },
            ];

            elementsToDraw.forEach(item => {
                const img = item.img;
                if (img) {
                    const drawWidth = item.size;
                    const drawHeight = item.size * (img.height / img.width); 
                    const offsetX = (CANVAS_WIDTH - drawWidth) / 2;
                    // ç¹ªè£½ä½ç½®ï¼šY è»¸ä¸­å¿ƒé» - ç¹ªåœ–é«˜åº¦çš„ä¸€åŠ
                    ctx.drawImage(img, offsetX, item.y - drawHeight / 2, drawWidth, drawHeight);
                }
            });


            // 4. ç¹ªè£½æ–‡å­—å€å¡Š
            const textX = CANVAS_WIDTH / 2;
            const textYStart = CANVAS_HEIGHT - 250; // Baseline for wish text
            const textWidth = CANVAS_WIDTH - PADDING * 2;
            const lineHeight = 35;

            // --- è§’è‰²å±¬æ€§æ¡† (ç›´å¼æ›¸å¯«ï¼Œæ¯å€‹å­—æ—‹è½‰ 90 åº¦ï¼Œç§»è‡³å³å´ï¼Œç„¡æ¡†ç·š/åœ“è§’) ---
            
            const ATTR_FONT_SIZE = 48; // **å·²æ”¾å¤§**
            const BOX_PADDING_X = 15; // æ°´å¹³å…§é‚Šè·
            const BOX_PADDING_Y = 10; // å‚ç›´å…§é‚Šè·
            
            const attrText = state.attribute;
            const chars = attrText.split(''); // å°‡æ–‡å­—æ‹†åˆ†æˆå–®å­—

            // å‚ç›´æ›¸å¯«ç›¸é—œè¨ˆç®—
            ctx.font = `bold ${ATTR_FONT_SIZE}px ${FONT_FAMILY}`;
            const charLineHeight = ATTR_FONT_SIZE * 1.2; // è¡Œé«˜
            const textHeightInRotatedSpace = (chars.length - 1) * charLineHeight + ATTR_FONT_SIZE; // å¯¦éš›æ–‡å­—é«˜åº¦
            
            // W_BOX (æ—‹è½‰å¾Œçš„å¯¬åº¦ï¼Œå³å¡ç‰‡ä¸Šçš„é«˜åº¦): æ–‡å­—é«˜åº¦ + å‚ç›´å…§é‚Šè·
            const W_BOX = textHeightInRotatedSpace + 2 * BOX_PADDING_Y; 
            // H_BOX (æ—‹è½‰å¾Œçš„é«˜åº¦ï¼Œå³å¡ç‰‡ä¸Šçš„å¯¬åº¦): æ–‡å­—å¯¬åº¦ + æ°´å¹³å…§é‚Šè·
            const H_BOX = ATTR_FONT_SIZE + 2 * BOX_PADDING_X; 

            // å®šä½æ—‹è½‰ä¸­å¿ƒé» (åœ¨å¡ç‰‡å³å´ï¼Œå¤§ç´„å‚ç›´å±…ä¸­)
            // å‘ä¸­é–“ç§»å‹• 1 å…¬åˆ† (30 åƒç´ )
            const ATTR_X = CANVAS_WIDTH - PADDING / 2 - H_BOX / 2 - 30; 
            // å‘ä¸Šç§»å‹• 4 å…¬åˆ† (120px)
            const ATTR_Y = CANVAS_HEIGHT / 2 - 260; 
            

            // ç¹ªè£½æ—‹è½‰çš„æ–¹æ¡†å’Œæ–‡å­—
            ctx.save();
            ctx.translate(ATTR_X, ATTR_Y); // ç§»å‹•åˆ°æ—‹è½‰ä¸­å¿ƒé»
            ctx.rotate(Math.PI / 2); // æ—‹è½‰ 90 åº¦ (ä½¿ X è»¸å‚ç›´)
            
            // ç¹ªè£½æ–¹æ¡† (ä½¿ç”¨ fillRect ç¹ªè£½ç„¡åœ“è§’çŸ©å½¢)
            const BOX_DRAW_X = -W_BOX / 2;
            const BOX_DRAW_Y = -H_BOX / 2;
            
            // å¡«å……æ–¹æ¡†
            ctx.fillStyle = '#F7F2E6'; // deity-light
            ctx.fillRect(BOX_DRAW_X, BOX_DRAW_Y, W_BOX, H_BOX);

            // ç¹ªè£½å±¬æ€§æ–‡å­— (æ¯å€‹å­—å…ƒå–®ç¨è™•ç†)
            ctx.fillStyle = '#9B7E50'; // deity-text
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle'; // è®“æ–‡å­—å‚ç›´å±…ä¸­
            
            const startXRotated = -textHeightInRotatedSpace / 2 + charLineHeight / 2;
            let currentXRotated = startXRotated;

            for (let i = 0; i < chars.length; i++) {
                ctx.save();
                
                // ç§»åˆ°å­—å…ƒä¸­å¿ƒé» (åœ¨æ—‹è½‰å¾Œçš„ X è»¸ä¸Šç§»å‹•)
                ctx.translate(currentXRotated, 0);

                // è®“å­—å…ƒæ—‹è½‰ -90 åº¦ (é †æ™‚é‡/å‘å³ 90 åº¦)
                ctx.rotate(-Math.PI / 2); 

                // ç¹ªè£½å–®å€‹å­—å…ƒ (ä½æ–¼æ–°çš„åŸé» (0, 0))
                ctx.fillText(chars[i], 0, 0); 
                
                ctx.restore();
                
                // ç§»å‹•ç¹ªåœ–é»åˆ°ä¸‹ä¸€å€‹å­—å…ƒ
                currentXRotated += charLineHeight;
            }

            ctx.restore(); // æ¢å¾© Canvas ç‹€æ…‹
            // --- è§’è‰²å±¬æ€§æ¡†çµæŸ ---

            // é¡˜æœ›ç•™è¨€ (æ­¥é©Ÿä¸‰)
            ctx.fillStyle = '#7A643F'; // é¡˜æœ›æ–‡å­—é¡è‰²æ”¹ç‚ºæ·±å’–å•¡è‰² (#7A643F)
            ctx.textAlign = 'left';

            const wishText = state.wish || 'æœŸå¾…æ‚¨çš„é¡˜æœ›ç•™è¨€...';
            
            // æ›è¡Œç¹ªè£½é¡˜æœ› (å±…ä¸­)
            ctx.font = `bold 22px ${FONT_FAMILY}`; // **å­—é«”åŠ å¤§**
            const wishDrawX = PADDING;
            
            // --- é¡˜æœ›æ–‡å­—æé‚Šè¨­å®š ---
            ctx.strokeStyle = '#FFFFFF'; // ç™½è‰²æé‚Š
            ctx.lineWidth = 2.5; // **æé‚ŠåŠ ç²—**
            drawWrappedText(`ã€Œ${wishText}ã€`, wishDrawX, textYStart + lineHeight + 10, textWidth, 30, true);

            // åº•éƒ¨ç°½å (å³å°é½Š)
            ctx.fillStyle = '#9B7E50'; // æ–‡å­—é¡è‰²: #9B7E50
            ctx.font = `bold 26px ${FONT_FAMILY}`; // **å­—é«”åŠ å¤§**
            ctx.textAlign = 'right';
            
            let nicknameDisplay = 'å°ˆå±¬å®ˆè­·ç¥å¡';
            if (state.nickname) {
                nicknameDisplay = `â€”â€” ${state.nickname} çš„å®ˆè­·ç¥`;
            }
            
            // --- ç°½åæ–‡å­—æé‚Šè¨­å®š ---
            ctx.strokeStyle = '#FFFFFF'; // ç™½è‰²æé‚Š
            ctx.lineWidth = 3; // **æé‚ŠåŠ ç²—**

            const nicknameX = CANVAS_WIDTH - PADDING;
            const nicknameY = CANVAS_HEIGHT - PADDING / 2;

            ctx.strokeText(nicknameDisplay, nicknameX, nicknameY); // Draw stroke first
            ctx.fillText(nicknameDisplay, nicknameX, nicknameY);   // Draw fill second

            // å•Ÿç”¨ä¸‹è¼‰æŒ‰éˆ•
            document.getElementById('download-btn').disabled = false;
        }

        /**
         * é‡æ–°éš¨æ©Ÿé¸æ“‡ç¥ç¦ (Q6)ã€‚
         */
        function refreshBlessing() {
            if (state.blessingToggle === 'yes') {
                const randomIndex = Math.floor(Math.random() * blessingMessages.length);
                state.blessingText = blessingMessages[randomIndex];
                document.getElementById('event-text').textContent = state.blessingText;
                document.getElementById('event-card').classList.remove('hidden');
            } else {
                state.blessingText = '';
                document.getElementById('event-text').textContent = '';
                document.getElementById('event-card').classList.add('hidden');
            }
        }


        // --- å…ƒç´ è¼‰å…¥è™•ç† (å·²æ›´æ–°ï¼Œæ¶µè“‹æ‰€æœ‰æ–°é¡åˆ¥) ---

        /**
         * è¼‰å…¥æ‰€æœ‰å…ƒç´ åœ–ç‰‡ï¼Œå®Œæˆå¾Œè§¸ç™¼ç¹ªåœ–ã€‚
         */
        function loadAllElements() {
            const allElements = [
                ...elementData.gender,
                ...elementData.headwear,
                ...elementData.outfit,
                ...elementData.background,
            ];
            
            let loadedCount = 0;
            const totalCount = allElements.length;

            if (totalCount === 0) {
                state.allElementsLoaded = true;
                drawDeityCard();
                return;
            }

            document.getElementById('loading-overlay').classList.remove('hidden');

            allElements.forEach(item => {
                const img = new Image();
                img.crossOrigin = 'Anonymous'; 
                img.onload = () => {
                    state.images[item.id] = img;
                    loadedCount++;
                    if (loadedCount === totalCount) {
                        state.allElementsLoaded = true;
                        document.getElementById('loading-overlay').classList.add('hidden');
                        refreshBlessing(); // åˆå§‹è¼‰å…¥æ™‚ä¹Ÿéš¨æ©ŸæŠ½ä¸€å€‹ç¥ç¦
                        drawDeityCard();
                    }
                };
                img.onerror = () => {
                    // ç”±æ–¼åœ–ç‰‡å·²æ›¿æ›ç‚º CORS å‹å–„çš„ä½”ä½ç¬¦ï¼Œæ­¤éŒ¯èª¤æ‡‰è©²ä¸æœƒç™¼ç”Ÿ
                    console.error(`Failed to load image: ${item.imageUrl}. æª¢æŸ¥é€£çµã€‚`);
                    loadedCount++;
                    if (loadedCount === totalCount) {
                        state.allElementsLoaded = true;
                        document.getElementById('loading-overlay').classList.add('hidden');
                        refreshBlessing();
                        drawDeityCard();
                    }
                };
                img.src = item.imageUrl;
            });
        }

        // --- UI æ¸²æŸ“èˆ‡äº’å‹•è™•ç† (å·²æ›´æ–°) ---

        /**
         * æ¸²æŸ“é¸æ“‡æŒ‰éˆ•ã€‚
         * @param {string} category é¡åˆ¥åç¨± (gender, headwear, outfit, background)
         * @param {string} title å€å¡Šæ¨™é¡Œ
         * @param {Array<Object>} items å…ƒç´ åˆ—è¡¨
         */
        function renderOptions(category, title, items) {
            const container = document.createElement('div');
            container.innerHTML = `<h3 class="text-lg font-medium mb-2 text-gray-700">${title}</h3>`;
            const innerDiv = document.createElement('div');
            innerDiv.className = 'flex flex-wrap gap-2';

            items.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.id = `btn-${item.id}`;
                button.className = `option-button px-4 py-2 text-sm rounded-full border-2 border-gray-200 text-gray-700 bg-white hover:bg-deity-light hover:border-deity-accent`;
                button.textContent = item.name;
                
                // è¨­ç½®åˆå§‹é¸æ“‡ç‹€æ…‹
                if (state[category] === item.id) {
                    button.classList.add('selected');
                }

                button.onclick = () => {
                    // æ›´æ–°ç‹€æ…‹
                    state[category] = item.id;
                    // æ›´æ–° UI é¸æ“‡ç‹€æ…‹
                    document.querySelectorAll(`#element-selection button[data-category="${category}"]`).forEach(btn => {
                        btn.classList.remove('selected');
                        btn.classList.remove('border-deity-accent');
                    });
                    button.classList.add('selected');
                    button.classList.add('border-deity-accent');
                    // é‡æ–°ç¹ªè£½å¡ç‰‡
                    drawDeityCard();
                };
                button.setAttribute('data-category', category);
                innerDiv.appendChild(button);
            });
            container.appendChild(innerDiv);
            document.getElementById('element-selection').appendChild(container);
        }

        /**
         * æ¸²æŸ“å±¬æ€§é¸æ“‡æŒ‰éˆ•ã€‚
         */
        function renderAttributes() {
            const container = document.getElementById('attribute-selection');
            attributes.forEach(attr => {
                const button = document.createElement('button');
                button.type = 'button';
                // èª¿æ•´äº† hover é¡è‰²ä»¥åŒ¹é…æ–°ä¸»é¡Œ
                button.className = `option-button px-4 py-3 text-sm rounded-xl border-2 border-gray-200 text-gray-700 bg-white hover:bg-deity-light hover:border-deity-accent font-semibold`;
                button.textContent = attr;

                // è¨­ç½®åˆå§‹é¸æ“‡ç‹€æ…‹
                if (state.attribute === attr) {
                    button.classList.add('selected');
                }

                button.onclick = () => {
                    // æ›´æ–°ç‹€æ…‹
                    state.attribute = attr;
                    // æ›´æ–° UI é¸æ“‡ç‹€æ…‹
                    document.querySelectorAll('#attribute-selection button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    button.classList.add('selected');
                    // é‡æ–°ç¹ªè£½å¡ç‰‡
                    drawDeityCard();
                };
                container.appendChild(button);
            });
        }


        /**
         * åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›£è½å™¨ã€‚
         */
        function setupEventListeners() {
            // æš±ç¨±è¼¸å…¥ç›£è½ (Q7)
            const nicknameInput = document.getElementById('nickname-input');
            const nicknameDisplay = document.getElementById('nickname-display');
            nicknameInput.addEventListener('input', (e) => {
                // é™åˆ¶å­—æ•¸
                if (e.target.value.length > 10) {
                    e.target.value = e.target.value.substring(0, 10);
                }
                state.nickname = e.target.value;
                nicknameDisplay.textContent = state.nickname ? `ç¥å¡åç¨±: ${state.nickname}` : '';
                drawDeityCard();
            });


            // é¡˜æœ›è¼¸å…¥ç›£è½ (Q3)
            const wishInput = document.getElementById('wish-input');
            const charCount = document.getElementById('char-count');
            wishInput.addEventListener('input', (e) => {
                // é™åˆ¶å­—æ•¸ (å·²å¢åŠ è‡³ 100 å­—ï¼Œä»¥å®¹ç´æ˜‡è¯å¾Œçš„ç¥ˆç¦±æ–‡)
                if (e.target.value.length > 100) {
                    e.target.value = e.target.value.substring(0, 100);
                }
                state.wish = e.target.value;
                charCount.textContent = state.wish.length;
                drawDeityCard();
            });

            // Gemini API è¨±é¡˜è©æ˜‡è¯æŒ‰éˆ•ç›£è½
            REFINE_WISH_BTN.addEventListener('click', refineWish);


            // éš¨æ©Ÿç¥ç¦é–‹é—œç›£è½ (Q6)
            document.querySelectorAll('input[name="blessing"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.blessingToggle = e.target.value;
                    refreshBlessing(); // åˆ‡æ›æ™‚é‡æ–°æŠ½æˆ–éš±è—
                });
            });

            // å®ˆè­·ç¥ç‰†æ„é¡˜ç›£è½ (Q8)
            document.querySelectorAll('input[name="consent"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    state.consent = e.target.value;
                    // é€™é‚Šä¸éœ€è¦é‡ç¹ªå¡ç‰‡ï¼Œå› ç‚ºä¸å½±éŸ¿è¦–è¦ºè¼¸å‡º
                });
            });


            // ä¸‹è¼‰æŒ‰éˆ•ç›£è½
            document.getElementById('download-btn').addEventListener('click', () => {
                // ç¢ºä¿ Canvas å…§å®¹æ˜¯æœ€æ–°çš„
                drawDeityCard();

                // ç²å– Canvas æ•¸æ“š URL
                const dataURL = canvas.toDataURL('image/png');
                
                // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„ä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `å®ˆè­·ç¥å¡-${state.nickname || state.attribute}.png`;
                
                // è§¸ç™¼ä¸‹è¼‰
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // å¯ä»¥åœ¨é€™è£¡å‘¼å« Firebase å„²å­˜æ•¸æ“š (å¦‚æœå·²å•Ÿç”¨)
                // if (firebaseConfig) {
                //     saveCardToFirestore({
                //         ...state,
                //         blessingText: state.blessingText,
                //         imageUrl: dataURL, // å„²å­˜ Base64 æ•¸æ“šä»¥ä¾¿åœ¨ç‰†ä¸Šå±•ç¤º
                //         // ...å…¶ä»–æ•¸æ“š
                //     });
                // }
            });
        }

        // --- æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ---
        window.onload = function () {
            // 1. æ¸²æŸ“æ‰€æœ‰é¸é … (é †åºä¾ç…§è¡¨å–®)
            renderOptions('gender', 'æ€§åˆ¥ï¼š', elementData.gender);
            renderOptions('headwear', 'ç‚ºä½ çš„ç¥é¸æ“‡é ­é£¾ ğŸ‘‘ï¼š', elementData.headwear);
            renderOptions('outfit', 'ç¥‚çš„æœè£é¢¨æ ¼ ğŸ‘˜ï¼š', elementData.outfit);
            renderOptions('background', 'ç¥‚çš„èƒŒæ™¯é¢¨æ ¼ğŸï¸ï¼š', elementData.background);
            
            // 2. æ¸²æŸ“å±¬æ€§
            renderAttributes();
            
            // 3. è¨­ç½®äº‹ä»¶ç›£è½å™¨
            setupEventListeners();

            // 4. è¼‰å…¥æ‰€æœ‰åœ–ç‰‡å…ƒç´ ä¸¦é–‹å§‹ç¹ªåœ–
            loadAllElements();
        };

    </script>
</body>
</html>
